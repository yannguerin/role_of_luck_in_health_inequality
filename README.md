# The Role of Luck in Health Inequality

## Installation

### Environment

Clone this repository onto your machine.

We've used conda for our virtual environment. Please ensure conda is installed on your machine (see [Install Conda](https://docs.conda.io/projects/conda/en/stable/#install))

The following commands are for a UNIX based operating system - and have only been tested on Linux. If you are running this on other operating systems you may encounter issues. For Windows, change "python3" to "py" when using Command Prompt. 

Create a virtual environment using conda, and install the required packages, by following this command:

```bash
conda env create -f environment.yml
```

Activate your environment:

```bash
conda activate health_inequity_simulation
```

You should now see (health_inequity_simulation) at the start of your terminal input.

Due to a dependency conflict with black-it, you will need to install an upgrade of pandas. Black-it requires a pandas version below version 2.0 which conflicts with the code in this project. To fix this, run the following command:

```bash
pip install --upgrade pandas
```

This will upgrade pandas to the newest version.


## Project Structure

- `figures/` is the output folder for the figures for the manuscript and its appendices
- `luck_vs_circumstance/` contains all the code for the model
- `results/` contains the results from the calibration, the interactive results, and the simulation datasets
- `run_calibration.py` is a script that calibrates the model parameters
- `build_interactive_results.py` is a script that builds interactive HTML files to explore the simulations
- `build_simulation_datasets.py` is a script that runs the simulations and saves the datasets to the `results/` folder
- `calibrated_parameters.py` is a file to store the calibrated parameters from the `run_calibration.py` script
- `environment.yml` contains the specifications to create the conda envrionemnt
- `interactive_plotting.py` is a module file that contains code used in building the interactive results
- `Gini_lifecourse_cross-sectional_31JAN2025.xlsx` contains tables and data of inequality calculations
- `manuscript_results.ipynb` is a Jupyter Notebook for creating the figures used in the manuscript
- `metadata.py` contains metadata about each simulation, used in multiple scripts


## Calibration

The calibration process calibrates the model's parameters based on empirical data. We use the black-it library for the calibration. The calibration process samples from the parameter space quasi-randomly to efficiently explore the parameter space.

See the run_calibration.py for options that can be modified to increase or decrease the amount of the parameter space that is explored during the calibration process.

To run the calibration with the current parameters, run the following command:

```bash
python3 run_calibration.py
```

This process may take several hours to complete. If you would like to speed up the process you can change the parameters right below `if __name__ == "__main__":` line in the `run_calibration.py` script. 

Once the script is completed, see the results/calibration_results folder to find the calibrated parameters (can be found in the image with filename that starts with "real_vs_model_mortality"). Then, in the calibrated_parameters.py file, modify the Parameters namedtuple object with the calibrated parameters.

## Simulations

To run the simulations created to exlore modifications to the base model, run build_interactive_results.py file using the following command:

```bash
python3 build_interactive_results.py
```

The interactive results, in HTML format, can be found in the results/interactive_results folder. There are two interactive files: main_simulation_results.html, and individual_simulation_results.html.

And, to create the simulation results datasets, run the build_simulation_datasets.py file using the following command:

```bash
python3 build_simulation_datasets.py
```

## Manuscript Figures

To recreate the figures used in the manuscript, run all the notebook `manuscript_results.ipynb`. This notebook relies on the simulation datasets generated by the build_simulation_datasets.py script. 